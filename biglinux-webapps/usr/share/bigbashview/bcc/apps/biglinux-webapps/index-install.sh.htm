#!/usr/bin/env bash

#Translation
export TEXTDOMAINDIR="/usr/share/locale"
export TEXTDOMAIN=biglinux-webapps

echo '
<!-- Cabeçalho -->
<head>

    <!-- Carregando o tema css do app -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min_litera.css">
    <link rel="stylesheet" type="text/css" href="css/tooltip.css">

    <!-- Carregando jquery e o js necessário -->
    <script type="application/javascript" src="js/jquery-3.6.0.min.js"></script>
    <script type="application/javascript" src="js/bootstrap.bundle.min.js"></script>
</head>

<!-- Corpo da página -->
<body id="app">
    <div class="container-fluid">
        <p class="text-center h3">
            <i class="bi bi-plus-circle"></i>
            '$"Instalar WebApps BigLinux"'
        </p>

        <!-- Formulário de instalação do webapp -->
        <form action="webapp-install.sh" method="get">

            <div class="row justify-content-center">
                <div class="col-8">
                    <label for="namedesk">'$"NOME:"'</label>
                    <input type="text" class="form-control form-control-sm"
                       name="namedesk" id="namedesk" required/>
                </div>
                <div class="mb-2 col-8">
                    <label for="urldesk" class="mt-2">'$"URL:"'</label>
                    <input type="text" class="form-control form-control-sm"
                       name="urldesk" id="urldesk" required/>
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-4">
                    <a data-bs-toggle="tooltip" data-bs-placement="top"
                       title="'$"Detecta automaticamente o título do site e sugere como nome do webapp."'"
                       class="btn btn-sm btn-primary btn-small-lg" id="gettitle">
                        <i class="bi bi-window"></i>
                       '$"Detectar Título"'
                   </a>
                </div>
                <div class="col-3">
                  <a data-bs-toggle="tooltip" data-bs-placement="top" data-html="true"
                     title="'$"Detecta automaticamente o ícone do site, mas não são todos os sites que suportam o recurso.<br>Por exemplo, sites que necessitam de login."'"
                     class="btn btn-sm btn-primary btn-small-lg" id="favicon">
                     <i class="bi bi-image-fill"></i>
                     '$"Detectar Ícone"'
                   </a>
                </div>
            </div>

            <div class="row">
                <div class="col-2"></div>
                <div class="mt-2 col-1">
                    <label for="icondesk" class="mb-1">'$"ÍCONE:"'</label><br>
                    <img id="preview" src="img/default.png" width="48" height="48"/>
                </div>
                <div class="mt-5 col-5">
                    <input type="text" id="icondesk" readonly
                           class="form-control form-control-sm align-content-start"/>
                    <input type="hidden" name="icondesk" id="icondeskhidden">
                </div>
                <div class="mt-5 col-1">
                    <a data-bs-toggle="tooltip" data-bs-placement="top"
                       title="'$"Carrega um arquivo de imagem para ser usado como ícone."'"
                       class="btn btn-sm btn-primary btn-small" id="btn">
                       <i class="bi bi-folder2-open"></i>
                       '$"Abrir"'
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-2"></div>
                <div class="mt-2 col-1">
                    <label class="mb-1">'$"NAVEGADOR:"'</label>
                    <img id="browsericon" width="48" height="48">
                </div>
                <div class="col-3">
                    <select name="browser" class="mt-5 form-select form-select-size">'

                        if [ -e /usr/lib/brave/brave ];then
                            echo '<option value="brave-browser" class="form-option">BRAVE BROWSER</option>'
                        fi

                        if [ -e /usr/lib/firefox/firefox ];then
                            echo '<option value="firefox" class="form-option">FIREFOX</option>'
                        fi

                        if [ -e /usr/lib/firefox-developer-edition/firefox ];then
                            echo '<option value="firefox-developer-edition" class="form-option">FIREFOX DEV</option>'
                        fi

                        if [ -e /opt/google/chrome/google-chrome ];then
                            echo '<option value="google-chrome" class="form-option">CHROME</option>'
                        fi

                        if [ -e /opt/google/chrome/google-chrome-beta ];then
                            echo '<option value="google-chrome-beta" class="form-option">CHROME BETA</option>'
                        fi

                        if [ -e /opt/google/chrome/google-chrome-unstable ];then
                            echo '<option value="google-chrome-unstable" class="form-option">CHROME DEV</option>'
                        fi

                        if [ -e /usr/lib/chromium/chromium ];then
                            echo '<option value="chromium" class="form-option">CHROMIUM</option>'
                        fi

                        if [ -e /opt/vivaldi/vivaldi ];then
                            echo '<option value="vivaldi" class="form-option">VIVALDI</option>'
                        fi

            echo   '</select>
                </div>
                <div class="mt-5 col-3 form-check form-switch" id="perfil">
                    <label class="form-check-label" data-bs-toggle="tooltip" data-bs-placement="top" for="newperfil"
                           title="'$"Essa opção permite que você crie webapps que não compartilham informações.<br>Por exemplo, para logar em contas de e-mails diferentes, assim cada webapp manterá o login separadamente."'" data-html="true">
                           <i class="bi bi-person-plus-fill"></i>
                           '$"Novo Perfil"'</label>
                     <input class="form-check-input" type="checkbox" name="newperfil" id="newperfil" />
                </div>
            </div>

            <div class="row justify-content-start">
                <div class="col-2">&nbsp;</div>
                <div class="mt-3 col-4 form-check form-switch" style="margin-left:15px;">
                    <label class="form-check-label" for="desktop" data-bs-toggle="tooltip"
                           data-bs-placement="top" title="'$"Adiciona um atalho na área de trabalho"'">
                      <i class="bi bi-link-45deg"></i>
                      '$"Adicionar atalho"'
                    </label>
                    <input class="form-check-input" id="desktop" type="checkbox" name="shortcut"/>
                </div>
            </div>

            <div class="row justify-content-start">
                <div class="col-2">&nbsp;</div>
                <div class="mt-2 col-4 form-check form-switch" id="modetv" style="margin-left:15px;">
                    <label class="form-check-label" data-bs-toggle="tooltip" data-bs-placement="top" for="tvmode"
                       title="'$"Essa opção permite que você visualize os vídeos do YouTube sem outras informações.<br>Por exemplo, sem propagandas e sem outros vídeos."'" data-html="true">
                       <i class="bi bi-tv"></i>
                       '$"YouTube em Modo TV"'
                    </label>
                    <input class="form-check-input" type="checkbox" name="tvmode" id="tvmode" />
                </div>
                <div class="col-4" id="modetv_empty" style="margin-left:15px;">&nbsp;</div>
                <div class="col-5">
                    <a href="index.sh.htm" class="btn btn-sm btn-dark btn-small-home"
                       data-bs-toggle="tooltip" data-bs-placement="top"
                       title="'$"Ir para página inicial"'">
                       <i class="bi home bi-house-fill"></i>
                    </a>
                    <button type="reset" class="btn btn-sm btn-dark btn-small"
                            onclick="location.reload(true);"
                            data-bs-toggle="tooltip" data-bs-placement="top"
                            title="'$"Limpar os campos"'">
                            <i class="bi bi-stars"></i>
                            '$"Limpar"'
                    </button>
                    <button type="submit" class="btn btn-sm btn-primary btn-small"
                            data-bs-toggle="tooltip" data-bs-placement="top"
                            title="'$"Iniciar instalação"'" id="install">
                            <i class="bi bi-check2-circle"></i>
                            '$"Instalar"'
                    </button>
                </div>
            </div>
        </form>
    </div>'

    echo "
    <script type='text/javascript'>
    \$(document).ready(function(){

        \$('.alert').hide();

        var iconSelected = \$('select').val();
        \$('#browsericon').attr('src', 'icons/'+iconSelected+'.png');
        if(iconSelected == 'firefox'){
            \$('#perfil').hide();
        } else {
            \$('#perfil').show();
        }

        \$('select').on('change', function(){
            \$('#browsericon').attr('src', 'icons/'+this.value+'.png');

            if(this.value == 'firefox'){
                \$('#perfil').hide();
            } else {
                \$('#perfil').show();
            }
        });

        \$('#modetv').hide();
        \$('#urldesk').keyup(function(){

            if(\$(this).val().match(/youtu/gi)){
                \$('#modetv').show();
                \$('#modetv_empty').hide();
            } else {
                \$('#modetv').hide();
                \$('#modetv_empty').show();
            }

            let url = \$('#urldesk').val()
            let check_icon = \$('#icondeskhidden').val().match(/tmp/gi);
            if (url && !/\s/.test(url)){
                if(check_icon){return;}
                \$.get('./get_auto_icon.sh.py', url,function(resp){
                    if (resp) {
                        \$('#icondeskhidden').val(resp);
                        \$('#icondesk').val(resp.replace(/.*\//, ''));
                        \$('#preview').attr('src', resp);
                        \$('#btn').html('""<i class=\"bi bi-arrow-repeat\"></i> "$"Alterar""');
                    } else {
                        return;
                    }
                });
            }

        });

        \$('#btn').click(function(e){
            e.preventDefault();

            \$.get('./get_dialog_icon.sh.py', function(dados){
                if (dados){
                    \$('#icondeskhidden').val(dados);
                    \$('#icondesk').val(dados.replace(/.*\//, ''));
                    \$('#preview').attr('src', dados);
                    \$('#btn').html('""<i class=\"bi bi-arrow-repeat\"></i> "$"Alterar""');
                } else {
                    return;
                }
            });
        });

        \$('#gettitle').click(function(e){
            e.preventDefault();

            let url = \$('#urldesk').val();

            if (url == 'https://' || !url){
                \$('#alert-url').fadeIn();
                \$('#urldesk').focus();
                setTimeout(function () {
                    \$('#urldesk').val('https://');
                    \$('#alert-url').fadeOut();
                },3000);
            } else {
                \$('#gettitle').html('""<i class=\"bi bi-window\"></i> "$"Detectando...""');
                \$.get('./get_title.sh.py', url, function(title){
                    if (title){
                        \$('#namedesk').focus();
                        \$('#namedesk').val(title);
                        \$('#gettitle').html('""<i class=\"bi bi-window\"></i> "$"Detectar Título""');
                    } else {
                        \$('#alert-title').fadeIn();
                        setTimeout(function(){
                            \$('#alert-title').fadeOut();
                            \$('#gettitle').html('""<i class=\"bi bi-window\"></i> "$"Detectar Título""');
                        }, 3000);
                        return;
                    }
                });
            }
        });

        \$('#favicon').click(function(e){
            e.preventDefault();

            let url = \$('#urldesk').val();

            if (url == 'https://' || !url){
                \$('#alert-url').fadeIn();
                \$('#urldesk').focus();
                setTimeout(function () {
                    \$('#urldesk').val('https://');
                    \$('#alert-url').fadeOut();
                },3000);
            } else {
                \$('#favicon').html('""<i class=\"bi bi-image-fill\"></i> "$"Detectando...""');
                \$.get('./get_favicon.sh.py', url, function(data){
                    if (data){
                        \$('#icondeskhidden').val(data);
                        \$('#icondesk').val(data.replace(/.*\//, ''));
                        \$('#preview').attr('src', data);
                        \$('#favicon').html('""<i class=\"bi bi-image-fill\"></i> "$"Detectar Ícone""');
                        \$('#btn').html('""<i class=\"bi bi-arrow-repeat\"></i> "$"Alterar""');
                    } else {
                        \$('#alert-favicon').fadeIn();
                        setTimeout(function(){
                            \$('#alert-favicon').fadeOut();
                            \$('#favicon').html('""<i class=\"bi bi-image-fill\"></i> "$"Detectar Ícone""');
                        }, 3000);
                        return;
                    }
                });
            }
        });

        \$('#install').click(function(e){
            let nome = \$('#namedesk').val();
            let url = \$('#urldesk').val();

            if (!nome){
                e.preventDefault();
                 \$('#alert-name').fadeIn();
                \$('#namedesk').focus();
                setTimeout(function () {
                    \$('#namedesk').val('webapp');
                    \$('#alert-name').fadeOut();
                },3000);
            } else if (url == 'https://' || !url){
                e.preventDefault();
                \$('#alert-url').fadeIn();
                \$('#urldesk').focus();
                setTimeout(function () {
                    \$('#urldesk').val('https://');
                    \$('#alert-url').fadeOut();
                },3000);
            } else {
                \$('#install').submit();
            }
        });
    });
    </script>"

echo '
<div class="alert alert-warning alert-fixed" id="alert-url">
  <div class="text-center"><strong>'$"Atenção!"'</strong> '$"Insira a URL para continuar"'</div>
</div>

<div class="alert alert-warning alert-fixed" id="alert-name">
  <div class="text-center"><strong>'$"Atenção!"'</strong> '$"Insira o nome para continuar"'</div>
</div>

<div class="alert alert-danger alert-fixed" id="alert-favicon">
  <div class="text-center"><strong>'$"Erro!"'</strong> '$"Não foi possível detectar o ícone!"'<br>'$"Verifique e tente novamente"'</div>
</div>

<div class="alert alert-danger alert-fixed" id="alert-title">
  <div class="text-center"><strong>'$"Erro!"'</strong> '$"Não foi possível detectar o título!"'<br>'$"Verifique e tente novamente"'</div>
</div>

</body>'
