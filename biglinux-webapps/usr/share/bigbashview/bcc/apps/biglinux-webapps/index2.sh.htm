#!/usr/bin/env bash

#Translation
export TEXTDOMAINDIR="/usr/share/locale"
export TEXTDOMAIN=biglinux-webapps

mkdir -p ~/.bigwebapps
[ ! -e ~/.bigwebapps/BROWSER ] && echo 'brave' > ~/.bigwebapps/BROWSER
BROWSER="$(<~/.bigwebapps/BROWSER)"
case $BROWSER in
    brave) selectbrave="selected" ;;
    chromium) selectchromium="selected" ;;
    google-chrome) selectchrome="selected" ;;
    vivaldi) selectvivaldi="selected" ;;
esac

echo '
<!-- Cabeçalho -->
    <head>
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min_litera.css">
        <link rel="stylesheet" type="text/css" href="css/tooltip.css">
        <script type="text/javascript" src="js/jquery-3.6.0.min.js"></script>
        <script type="text/javascript" src="js/bootstrap.bundle.min.js"></script>

    </head>
    <body id="app">
        <div class="container-fluid">
            <div class="row">
                <div class="col-1"></div>
                <div class="col-1">
                    <a href="index.sh.htm" class="btn btn-sm btn-dark btn-small-home mt-2"
                       data-bs-toggle="tooltip" data-bs-placement="top"
                       title="'$"Tela Inicial"'" style="margin-left:-10px">
                       <i class="bi home bi-house-fill"></i>
                    </a>
                </div>
                <div class="col-8">
                    <p class="text-center h3">
                        '$"Ativar ou Desativar os WebApps BigLinux"'
                    </p>
                </div>
            </div>'

DESKTOP="$(ls /usr/share/biglinux/webapps/*.desktop | sort )"

if [ "$DESKTOP" ]; then
    echo '<div class="row">
        <div class="col-1"></div>
        <div class="col-10 box-shadow">
          <table class="table table-hover table-striped mb-0 table-fixed">
            <thead>
                <tr class="table-dark" style="line-height:38px">
                    <th scope="col" class="text-center col-2">'$"NAVEGADOR:"'</th>

                    <th scope="col" class="text-center col-4">
                        <select class="form-select form-select-size">'

                            if [ -e /usr/lib/brave/brave ];then
                                echo " <option class='form-option' value='brave-browser' $selectbrave>BRAVE</option>"
                            fi
                            if [ -e /opt/google/chrome/google-chrome -o \
                                 -e /opt/google/chrome-beta/google-chrome-beta -o \
                                 -e /opt/google/chrome-unstable/google-chrome-unstable ];then
                                echo " <option class='form-option' value='google-chrome' $selectchrome>GOOGLE CHROME</option>"
                            fi
                            if [ -e /usr/lib/chromium/chromium ];then
                                echo " <option class='form-option' value='chromium' $selectchromium>CHROMIUM</option>"
                            fi
                            if [ -e /opt/vivaldi/vivaldi ];then
                                echo " <option class='form-option' value='vivaldi' $selectvivaldi>VIVALDI</option>"
                            fi
                    echo '
                        </select>

                    </th>
                    <th scope="col" class="text-center col-1">
                        <img id="browsericon" width="38" height="38" class="center">
                    </th>
                    <th scope="col" class="col-1">&nbsp;</th>
                    <th scope="col" class="col-4">
                      <div class="input-group">
                        <span class="input-group-text" style="height:36px;margin-top:1px">
                          <i class="bi bi-funnel-fill"></i>
                        </span>
                        <input type="search" class="form-control" placeholder="'$"Filtro"'"
                               id="filter" style="line-height:20px">
                      </div>
                    </th>
                </tr>
                <tr class="table-dark">
                  <th class="text-center col-2" scope="col">'$"ÍCONE"'</th>
                  <th class="text-center col-8" scope="col">'$"NOME"'</th>
                  <th class="text-center col-2" scope="col">'$"AÇÃO"'</th>
                </tr>
            </thead>
            <tbody id="table-filter">'
for i in $DESKTOP; do

    namedesk="$(basename $i)"

    if [ -e "$HOME/.local/share/applications/$namedesk" ]; then
        check="checked"
        STATUS=$"Desativar"
    else
        check=""
        STATUS=$"Ativar"
    fi

    if [ ! "$(grep -E '(en|es)' <<< $LANGUAGE)" -a "$(grep 'pt' <<< $LANG)" ]; then

        if [ "$(grep -E "(Name\[pt\]=|Name\[pt_BR\]=)" $i)" ]; then
            DESKNAME="$(grep -E "(Name\[pt\]=|Name\[pt_BR\]=)" $i | sed 's|Name\[pt\]=||;s|Name\[pt_BR\]=||')"
        else
            DESKNAME="$(grep 'Name=' $i | sed 's|Name=||')"
        fi
    else
        DESKNAME="$(grep 'Name=' $i | sed 's|Name=||')"
    fi


    ICON="/usr/share/icons/hicolor/128x128/apps/$(grep 'Icon=' $i | sed 's|Icon=||')"
    [ ! -e "$ICON" ] && ICON="/usr/share/pixmaps/$(grep 'Icon=' $i | sed 's|Icon=||')"

    echo '<tr class="table-light">
            <td class="col-2">
                <img class="center img-thumbnail" src="'$ICON'" width="42" height="42"/>
            </td>
            <td class="align-middle text-center col-8">
                <big class="table-fixed-text">'$DESKNAME'</big>
            </td>
            <td class="col-2">
                <div class="form-check">
                    <label class="form-check-label"></label>
                    <input class="form-check-input table-fixed-input input-desk" '$check'
                           type="checkbox" data-bs-toggle="tooltip"
                           data-bs-placement="top" title="'$STATUS'" value="'$namedesk'"/>
                </div>
            </td>
    </tr>'
done
        echo '      </tbody>
                </table>
              </div>
          </div>
          <div class="row justify-content-center">

        </div>
    </div>
<script type="text/javascript">
    $(document).ready(function(){

        let iconSelected = $("select").val();
        $("#browsericon").attr("src", "icons/"+iconSelected+".png");

        $("select").on("change", function(){
            $.get("./change_browser.sh", this.value);
            $("#browsericon").attr("src", "icons/"+this.value+".png");
        });

        $("input[type=checkbox]").on("change", function(){
            let dis = $(this);
            $.get("./enable-disable.sh", dis.val(), function(s){
                if (s == "on"){
                    dis.tooltip("hide").attr("data-original-title", "'$"Desativar"'");
                } else {
                    dis.tooltip("hide").attr("data-original-title", "'$"Ativar"'");
                }
            });
        });

        $("#filter").on("keyup", function(){
            let value = $(this).val().toLowerCase();
            $("#table-filter tr").filter(function() {
              $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });


    });
</script>
'
fi
